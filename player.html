<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">
    <title>TuneX</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
          rel="stylesheet">
    <style>
        /* ── Themes ──────────────────────────────────────────────────────────────── */
        :root, [data-theme="midnight"] {
            --bg: #0a0a0f;
            --bg2: #111118;
            --surface: #16161f;
            --card: #1e1e2a;
            --card2: #252535;
            --accent: #7c5ce8;
            --accent2: #a78bfa;
            --accent3: #c4b5fd;
            --glow: #7c5ce840;
            --text: #f0f0f8;
            --sub: #7070a0;
            --sub2: #4a4a70;
            --border: #2a2a3a;
            --player-bg: #12121a;
            --waveform: #7c5ce8;
        }

        [data-theme="aurora"] {
            --bg: #050d12;
            --bg2: #0a1520;
            --surface: #0f1e2c;
            --card: #162535;
            --card2: #1e3040;
            --accent: #00d4aa;
            --accent2: #00ffcc;
            --accent3: #80ffee;
            --glow: #00d4aa40;
            --text: #e0f8f4;
            --sub: #4a8070;
            --sub2: #2a5040;
            --border: #1a3040;
            --player-bg: #080f18;
            --waveform: #00d4aa;
        }

        [data-theme="ember"] {
            --bg: #100a06;
            --bg2: #180e08;
            --surface: #201208;
            --card: #2a1a0e;
            --card2: #341f12;
            --accent: #f06020;
            --accent2: #ff8040;
            --accent3: #ffaa70;
            --glow: #f0602040;
            --text: #fff0e8;
            --sub: #907060;
            --sub2: #603020;
            --border: #3a2010;
            --player-bg: #130d08;
            --waveform: #f06020;
        }

        [data-theme="sakura"] {
            --bg: #0f080d;
            --bg2: #170d14;
            --surface: #1e1019;
            --card: #271420;
            --card2: #301828;
            --accent: #e06090;
            --accent2: #f080a8;
            --accent3: #ffaac8;
            --glow: #e0609040;
            --text: #fff0f5;
            --sub: #907080;
            --sub2: #604050;
            --border: #351828;
            --player-bg: #110a10;
            --waveform: #e06090;
        }

        [data-theme="arctic"] {
            --bg: #f2f4f8;
            --bg2: #e8ecf4;
            --surface: #ffffff;
            --card: #f8faff;
            --card2: #eef2fa;
            --accent: #3060e8;
            --accent2: #5080ff;
            --accent3: #8090e8;
            --glow: #3060e820;
            --text: #101828;
            --sub: #607090;
            --sub2: #a0b0c8;
            --border: #d0d8e8;
            --player-bg: #ffffff;
            --waveform: #3060e8;
        }

        [data-theme="cyberpunk"] {
            --bg: #0a0015;
            --bg2: #150025;
            --surface: #1a0033;
            --card: #240055;
            --card2: #2e0066;
            --accent: #ff006e;
            --accent2: #ff3385;
            --accent3: #ff66b3;
            --glow: #ff006e40;
            --text: #ffccff;
            --sub: #cc66ff;
            --sub2: #9933cc;
            --border: #4d0088;
            --player-bg: #0f0020;
            --waveform: #ff006e;
        }

        [data-theme="forest"] {
            --bg: #0a1a0a;
            --bg2: #0d2615;
            --surface: #0f3318;
            --card: #144020;
            --card2: #1a4d28;
            --accent: #2dd4bf;
            --accent2: #45e5d1;
            --accent3: #6feae3;
            --glow: #2dd4bf40;
            --text: #d1f3ed;
            --sub: #7ec8b8;
            --sub2: #4a9882;
            --border: #1a6650;
            --player-bg: #0a1a10;
            --waveform: #2dd4bf;
        }

        [data-theme="sunset"] {
            --bg: #1a0a05;
            --bg2: #2d1207;
            --surface: #3d1810;
            --card: #552410;
            --card2: #662d15;
            --accent: #ff7043;
            --accent2: #ff8a66;
            --accent3: #ffaa88;
            --glow: #ff704340;
            --text: #fff3e0;
            --sub: #ffb399;
            --sub2: #ff9966;
            --border: #8b4423;
            --player-bg: #1f0d08;
            --waveform: #ff7043;
        }

        [data-theme="lavender"] {
            --bg: #0f0820;
            --bg2: #16122a;
            --surface: #1c1633;
            --card: #272140;
            --card2: #32284d;
            --accent: #b19cd9;
            --accent2: #c9b8e4;
            --accent3: #dcc9f0;
            --glow: #b19cd940;
            --text: #efe4ff;
            --sub: #a898cc;
            --sub2: #8b78b3;
            --border: #5a4d7a;
            --player-bg: #120a24;
            --waveform: #b19cd9;
        }

        [data-theme="obsidian"] {
            --bg: #060606;
            --bg2: #0a0a0a;
            --surface: #0f0f0f;
            --card: #1a1a1a;
            --card2: #252525;
            --accent: #00ff88;
            --accent2: #33ffaa;
            --accent3: #66ffcc;
            --glow: #00ff8840;
            --text: #e8e8e8;
            --sub: #808080;
            --sub2: #4d4d4d;
            --border: #303030;
            --player-bg: #0a0a0a;
            --waveform: #00ff88;
        }

        /* ── Reset & Base ────────────────────────────────────────────────────────── */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Syne', sans-serif;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            overscroll-behavior: none;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            background: none;
            color: inherit;
        }

        input {
            font-family: inherit;
        }

        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 2px;
        }

        /* ── Animated background ─────────────────────────────────────────────────── */
        .bg-orbs {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .bg-orbs::before, .bg-orbs::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.12;
            animation: orbFloat 20s ease-in-out infinite alternate;
        }

        .bg-orbs::before {
            width: 500px;
            height: 500px;
            background: var(--accent);
            top: -200px;
            left: -200px;
        }

        .bg-orbs::after {
            width: 400px;
            height: 400px;
            background: var(--accent2);
            bottom: -150px;
            right: -150px;
            animation-delay: -10s;
            animation-duration: 25s;
        }

        @keyframes orbFloat {
            0% {
                transform: translate(0, 0) scale(1);
            }
            100% {
                transform: translate(60px, 40px) scale(1.15);
            }
        }

        /* ── Layout ──────────────────────────────────────────────────────────────── */
        #app {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            height: 100dvh;
        }

        /* ── Header ──────────────────────────────────────────────────────────────── */
        header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: color-mix(in srgb, var(--surface) 90%, transparent);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 1.1rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--accent2), var(--accent3));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .search-wrap {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 0 14px;
            gap: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-wrap:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--glow);
        }

        .search-wrap svg {
            flex-shrink: 0;
            opacity: 0.5;
        }

        #q {
            flex: 1;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.9rem;
            padding: 10px 0;
            outline: none;
            min-width: 0;
        }

        #q::placeholder {
            color: var(--sub2);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        #auth-wrap {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        #apikey {
            width: 130px;
            padding: 8px 10px;
            font-size: 0.78rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        }

        #apikey:focus {
            border-color: var(--accent);
        }

        #connect-btn {
            padding: 8px 14px;
            font-size: 0.78rem;
            font-weight: 700;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: 'Syne', sans-serif;
        }

        #connect-btn:hover {
            background: var(--accent2);
            transform: translateY(-1px);
        }

        #connect-btn:active {
            transform: translateY(0);
        }

        #user-badge {
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--accent2);
            background: color-mix(in srgb, var(--accent) 15%, transparent);
            padding: 5px 10px;
            border-radius: 20px;
            border: 1px solid color-mix(in srgb, var(--accent) 30%, transparent);
            white-space: nowrap;
            display: none;
        }

        #theme-btn {
            width: 34px;
            height: 34px;
            border-radius: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        #theme-btn:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        /* ── Theme panel ─────────────────────────────────────────────────────────── */
        #theme-panel {
            position: fixed;
            top: 60px;
            right: 12px;
            z-index: 200;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px;
            display: none;
            flex-direction: column;
            gap: 8px;
            box-shadow: 0 20px 60px #0008;
            animation: panelIn 0.2s ease;
        }

        #theme-panel.open {
            display: flex;
        }

        @keyframes panelIn {
            from {
                opacity: 0;
                transform: translateY(-8px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }

        .theme-label {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--sub);
            text-transform: uppercase;
            padding: 0 4px;
        }

        .theme-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .theme-opt {
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 2px solid transparent;
            transition: all 0.2s;
            text-align: left;
            font-family: 'Syne', sans-serif;
        }

        .theme-opt:hover {
            transform: scale(1.03);
        }

        .theme-opt.active {
            border-color: var(--accent) !important;
        }

        /* ── Main layout ─────────────────────────────────────────────────────────── */
        .layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ── Sidebar ─────────────────────────────────────────────────────────────── */
        #sidebar {
            width: 200px;
            flex-shrink: 0;
            background: color-mix(in srgb, var(--surface) 80%, transparent);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            transition: width 0.25s ease, transform 0.25s ease;
        }

        .nav-section {
            padding: 16px 8px 4px;
        }

        .nav-label {
            font-size: 0.65rem;
            letter-spacing: 1.5px;
            font-weight: 700;
            color: var(--sub2);
            text-transform: uppercase;
            padding: 0 10px 6px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--sub);
            transition: all 0.15s;
            user-select: none;
            position: relative;
        }

        .nav-item:hover {
            color: var(--text);
            background: var(--card);
        }

        .nav-item.active {
            color: var(--accent2);
            background: color-mix(in srgb, var(--accent) 12%, transparent);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 25%;
            height: 50%;
            width: 3px;
            background: var(--accent2);
            border-radius: 0 2px 2px 0;
        }

        .nav-ico {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .playlist-items {
            padding: 0 8px;
        }

        .pl-nav-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 7px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.78rem;
            color: var(--sub);
            transition: all 0.15s;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pl-nav-item:hover {
            color: var(--text);
            background: var(--card);
        }

        .pl-nav-item.active {
            color: var(--accent2);
            background: color-mix(in srgb, var(--accent) 10%, transparent);
        }

        .pl-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent);
            flex-shrink: 0;
        }

        #new-pl-btn {
            margin: 4px 8px 8px;
            padding: 8px 12px;
            width: calc(100% - 16px);
            border-radius: 8px;
            font-size: 0.78rem;
            font-weight: 600;
            color: var(--sub);
            border: 1px dashed var(--border);
            transition: all 0.2s;
            text-align: left;
            font-family: 'Syne', sans-serif;
        }

        #new-pl-btn:hover {
            color: var(--accent2);
            border-color: var(--accent);
        }

        /* ── Main content ────────────────────────────────────────────────────────── */
        #main {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .page {
            padding: 20px;
            animation: pageIn 0.25s ease;
        }

        @keyframes pageIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 800;
            letter-spacing: -0.3px;
        }

        .section-sub {
            font-size: 0.75rem;
            color: var(--sub);
            margin-top: 2px;
        }

        .section-action {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent2);
            cursor: pointer;
            padding: 4px 10px;
            border-radius: 6px;
            transition: background 0.15s;
            font-family: 'Syne', sans-serif;
        }

        .section-action:hover {
            background: color-mix(in srgb, var(--accent) 12%, transparent);
        }

        /* ── Track cards ─────────────────────────────────────────────────────────── */
        .track-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .track-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
            position: relative;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        .track-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, var(--accent) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .track-card:hover {
            background: var(--card);
        }

        .track-card:hover::before {
            opacity: 0.04;
        }

        .track-card.active {
            background: color-mix(in srgb, var(--accent) 10%, transparent);
        }

        .track-card.active::before {
            opacity: 0.08;
        }

        .track-num {
            width: 24px;
            text-align: center;
            font-size: 0.75rem;
            color: var(--sub2);
            font-family: 'JetBrains Mono', monospace;
            flex-shrink: 0;
        }

        .track-card.active .track-num {
            display: none;
        }

        .track-card.active .playing-icon {
            display: flex;
        }

        .playing-icon {
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .playing-bars {
            display: flex;
            gap: 2px;
            align-items: flex-end;
            height: 14px;
        }

        .playing-bars span {
            width: 3px;
            background: var(--accent2);
            border-radius: 1px;
            animation: barBounce 0.7s ease-in-out infinite alternate;
        }

        .playing-bars span:nth-child(2) {
            animation-delay: 0.15s;
        }

        .playing-bars span:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes barBounce {
            from {
                height: 4px;
            }
            to {
                height: 14px;
            }
        }

        .track-thumb {
            width: 44px;
            height: 44px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
            background: var(--card2);
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-title {
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-meta {
            font-size: 0.72rem;
            color: var(--sub);
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-dur {
            font-size: 0.72rem;
            color: var(--sub2);
            flex-shrink: 0;
            font-family: 'JetBrains Mono', monospace;
        }

        .track-actions {
            display: flex;
            gap: 2px;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.15s;
        }

        .track-card:hover .track-actions {
            opacity: 1;
        }

        .track-actions button {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            color: var(--sub);
        }

        .track-actions button:hover {
            background: var(--card2);
            color: var(--text);
        }

        .track-actions button.liked {
            color: #f080a0;
        }

        /* ── Context menu ────────────────────────────────────────────────────────── */
        #ctx-menu {
            position: fixed;
            z-index: 500;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            min-width: 180px;
            box-shadow: 0 16px 40px #0008;
            display: none;
            animation: panelIn 0.15s ease;
        }

        #ctx-menu.open {
            display: block;
        }

        .ctx-item {
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.82rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--sub);
            transition: all 0.12s;
        }

        .ctx-item:hover {
            color: var(--text);
            background: var(--card);
        }

        .ctx-item.danger {
            color: #f06060;
        }

        .ctx-sep {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        /* ── Playlists grid ──────────────────────────────────────────────────────── */
        .pl-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
        }

        .pl-card {
            background: var(--card);
            border-radius: 14px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }

        .pl-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px var(--glow);
            border-color: color-mix(in srgb, var(--accent) 30%, transparent);
        }

        .pl-thumb {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: var(--card2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .pl-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .pl-card-info {
            padding: 10px;
        }

        .pl-card-name {
            font-size: 0.82rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pl-card-count {
            font-size: 0.7rem;
            color: var(--sub);
            margin-top: 2px;
        }

        .new-pl-card {
            background: var(--card);
            border-radius: 14px;
            cursor: pointer;
            border: 2px dashed var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            transition: all 0.2s;
            color: var(--sub);
            font-size: 0.8rem;
            font-weight: 600;
            gap: 6px;
        }

        .new-pl-card:hover {
            border-color: var(--accent);
            color: var(--accent2);
            transform: scale(1.02);
        }

        /* ── Empty state ─────────────────────────────────────────────────────────── */
        .empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--sub);
            animation: pageIn 0.3s ease;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-text {
            font-size: 0.9rem;
        }

        /* ── Loading ─────────────────────────────────────────────────────────────── */
        .loader {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ── Player bar ──────────────────────────────────────────────────────────── */
        #player {
            background: color-mix(in srgb, var(--player-bg) 95%, transparent);
            backdrop-filter: blur(30px);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            padding: env(safe-area-inset-bottom, 0) 0 0;
        }

        #player-inner {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Now playing */
        #now-playing {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 0 220px;
            min-width: 0;
        }

        #now-thumb {
            width: 46px;
            height: 46px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--card);
            flex-shrink: 0;
            transition: all 0.3s;
        }

        #now-thumb.spinning {
            animation: thumbPulse 3s ease-in-out infinite alternate;
        }

        @keyframes thumbPulse {
            from {
                box-shadow: 0 0 0 0 var(--glow);
            }
            to {
                box-shadow: 0 0 0 8px transparent;
            }
        }

        #now-info {
            min-width: 0;
        }

        #now-title {
            font-size: 0.82rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #now-channel {
            font-size: 0.7rem;
            color: var(--sub);
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #now-like {
            font-size: 1rem;
            flex-shrink: 0;
            padding: 4px;
            color: var(--sub);
            transition: all 0.2s;
        }

        #now-like.liked {
            color: #f080a0;
            animation: heartPop 0.3s ease;
        }

        @keyframes heartPop {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.4);
            }
        }

        /* Controls */
        .player-controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            flex: 1;
            max-width: 480px;
            margin: 0 auto;
            justify-content: center;
        }

        .ctrl-btns {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .ctrl-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--sub);
            transition: all 0.15s;
        }

        .ctrl-btn:hover {
            color: var(--text);
            background: var(--card);
            transform: scale(1.1);
        }

        .ctrl-btn:active {
            transform: scale(0.95);
        }

        .ctrl-btn.active {
            color: var(--accent2);
        }

        #play-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-size: 1.1rem;
            box-shadow: 0 4px 16px var(--glow);
            transition: all 0.15s;
        }

        #play-btn:hover {
            background: var(--accent2);
            transform: scale(1.08);
            box-shadow: 0 6px 24px var(--glow);
        }

        #play-btn:active {
            transform: scale(0.95);
        }

        #play-btn.loading {
            animation: btnPulse 1s ease-in-out infinite;
        }

        @keyframes btnPulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        /* Progress */
        .progress-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .time-label {
            font-size: 0.65rem;
            color: var(--sub);
            font-family: 'JetBrains Mono', monospace;
            white-space: nowrap;
        }

        .progress-wrap {
            flex: 1;
            position: relative;
            height: 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        #progress-track {
            width: 100%;
            height: 4px;
            background: var(--card2);
            border-radius: 2px;
            position: relative;
            overflow: visible;
        }

        #progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 2px;
            width: 0%;
            transition: width 0.25s linear;
            position: relative;
        }

        #progress-fill::after {
            content: '';
            position: absolute;
            right: -5px;
            top: 50%;
            transform: translateY(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent3);
            opacity: 0;
            transition: opacity 0.15s;
            box-shadow: 0 0 8px var(--glow);
        }

        .progress-wrap:hover #progress-fill::after {
            opacity: 1;
        }

        /* Volume */
        .vol-row {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 140px;
            justify-content: flex-end;
        }

        .vol-ico {
            font-size: 0.85rem;
            color: var(--sub);
            cursor: pointer;
            flex-shrink: 0;
        }

        .vol-track {
            flex: 1;
            height: 4px;
            background: var(--card2);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
            max-width: 80px;
        }

        .vol-fill {
            height: 100%;
            background: var(--sub);
            border-radius: 2px;
            width: 80%;
        }

        /* ── Modals ──────────────────────────────────────────────────────────────── */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 400;
            background: #0009;
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 380px;
            animation: modalIn 0.25s ease;
            box-shadow: 0 30px 80px #0008;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.92) translateY(10px);
            }
            to {
                opacity: 1;
                transform: none;
            }
        }

        .modal h2 {
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 10px 14px;
            font-size: 0.9rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            outline: none;
            font-family: 'Syne', sans-serif;
            transition: border-color 0.2s;
        }

        .modal-input:focus {
            border-color: var(--accent);
        }

        .modal-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.85rem;
            transition: all 0.15s;
            font-family: 'Syne', sans-serif;
        }

        .modal-btn.primary {
            background: var(--accent);
            color: white;
        }

        .modal-btn.primary:hover {
            background: var(--accent2);
        }

        .modal-btn.secondary {
            background: var(--card);
            color: var(--sub);
        }

        .modal-btn.secondary:hover {
            color: var(--text);
        }

        /* ── Toast ───────────────────────────────────────────────────────────────── */
        #toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 0.82rem;
            font-weight: 600;
            opacity: 0;
            transition: all 0.25s;
            z-index: 999;
            pointer-events: none;
            box-shadow: 0 8px 24px #0006;
            white-space: nowrap;
        }

        #toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ── Mobile nav (bottom) ─────────────────────────────────────────────────── */
        #mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 200;
            background: color-mix(in srgb, var(--surface) 95%, transparent);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            padding: 8px 0 env(safe-area-inset-bottom, 8px);
            flex-shrink: 0;
        }

        .mobile-nav-inner {
            display: flex;
            justify-content: space-around;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 4px 16px;
            cursor: pointer;
            color: var(--sub);
            transition: color 0.15s;
            font-size: 0.6rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .mobile-nav-item.active {
            color: var(--accent2);
        }

        .mobile-nav-item span:first-child {
            font-size: 1.2rem;
        }

        /* ── Responsive ──────────────────────────────────────────────────────────── */
        @media (max-width: 900px) {
            .theme-options {
                grid-template-columns: 1fr;
            }

            #theme-panel {
                max-width: 200px;
            }
        }

        @media (max-width: 700px) {
            #theme-panel {
                top: 54px;
                right: 8px;
                max-height: 400px;
                overflow-y: auto;
                max-width: 180px;
            }

            .theme-opt {
                padding: 6px 10px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 700px) {
            #sidebar {
                display: none;
            }

            #mobile-nav {
                display: flex;
            }

            #now-playing {
                flex: 0 0 auto;
                max-width: 140px;
                min-width: 0;
            }

            #now-channel {
                display: none;
            }

            #now-title {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .vol-row {
                display: none;
            }

            .player-controls {
                max-width: 100%;
                flex: 1;
            }

            .ctrl-btns {
                justify-content: center;
                width: 100%;
            }

            .progress-row {
                width: 100%;
                margin: 0 4px;
            }

            #player-inner {
                gap: 6px;
                padding: 8px 10px;
                flex-wrap: wrap;
            }

            #now-playing {
                order: 2;
                width: 100%;
                margin-top: 4px;
            }

            .player-controls {
                order: 1;
                width: 100%;
                max-width: 100%;
            }

            #player {
                bottom: 56px;
                position: fixed;
                width: 100%;
            }

            #app {
                padding-bottom: calc(56px + 70px);
            }

            #main {
                padding-bottom: 0;
            }

            header {
                padding: 10px 12px;
                gap: 8px;
            }

            .search-wrap {
                flex-shrink: 1;
            }

            #apikey {
                width: 110px;
            }

            .page {
                padding: 14px;
            }

            .ctrl-btn {
                width: 30px;
                height: 30px;
            }

            #play-btn {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }

            body {
                padding-bottom: 56px;
            }

            #now-thumb {
                width: 38px;
                height: 38px;
            }

            .track-card {
                padding: 6px 8px;
            }

            .track-thumb {
                width: 40px;
                height: 40px;
            }

            .track-title {
                font-size: 0.8rem;
            }

            .track-meta {
                font-size: 0.68rem;
            }

            .track-dur {
                font-size: 0.68rem;
            }

            .section-title {
                font-size: 0.95rem;
            }

            .pl-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 10px;
            }

            .pl-card-name {
                font-size: 0.78rem;
            }

            .pl-card-count {
                font-size: 0.65rem;
            }

            .modal {
                max-width: 90vw;
            }
        }

        @media (max-width: 500px) {
            .logo {
                font-size: 1rem;
            }

            #apikey {
                width: 85px;
                font-size: 0.68rem;
                padding: 6px 8px;
            }

            #connect-btn {
                padding: 6px 10px;
                font-size: 0.7rem;
            }

            .time-label {
                font-size: 0.55rem;
            }

            .track-card {
                padding: 5px 6px;
                gap: 8px;
            }

            .track-thumb {
                width: 38px;
                height: 38px;
            }

            .track-num {
                width: 20px;
                font-size: 0.7rem;
            }

            .track-title {
                font-size: 0.78rem;
            }

            .track-meta {
                font-size: 0.65rem;
            }

            .pl-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }

            .pl-card {
                border-radius: 10px;
            }

            .pl-card-info {
                padding: 8px;
            }

            .pl-card-name {
                font-size: 0.75rem;
            }

            .track-actions button {
                width: 26px;
                height: 26px;
                font-size: 0.75rem;
            }

            .section-title {
                font-size: 0.9rem;
            }

            .section-action {
                font-size: 0.7rem;
            }

            #now-thumb {
                width: 36px;
                height: 36px;
            }

            .ctrl-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }

            #play-btn {
                width: 36px;
                height: 36px;
                font-size: 0.95rem;
            }

            header {
                padding: 8px 10px;
            }

            .page {
                padding: 12px;
            }

            .nav-item {
                padding: 8px 10px;
                font-size: 0.8rem;
            }

            .search-wrap {
                padding: 0 10px;
            }

            #q {
                font-size: 0.85rem;
            }
        }

        @media (max-width: 380px) {
            .logo {
                display: none;
            }

            #apikey {
                width: 75px;
                font-size: 0.65rem;
            }

            header {
                padding: 6px 8px;
                gap: 4px;
            }

            .search-wrap {
                padding: 0 8px;
                gap: 6px;
            }

            #q {
                font-size: 0.8rem;
            }

            #connect-btn {
                padding: 5px 8px;
                font-size: 0.65rem;
            }

            #theme-btn {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }

            .time-label {
                font-size: 0.5rem;
            }

            #now-thumb {
                width: 34px;
                height: 34px;
            }

            .ctrl-btn {
                width: 26px;
                height: 26px;
                font-size: 0.85rem;
            }

            #play-btn {
                width: 34px;
                height: 34px;
                font-size: 0.9rem;
            }

            #player-inner {
                gap: 4px;
                padding: 6px 8px;
            }

            .mobile-nav-item {
                padding: 3px 12px;
                font-size: 0.55rem;
                gap: 2px;
            }

            .mobile-nav-item span:first-child {
                font-size: 1rem;
            }

            .page {
                padding: 10px;
            }

            .section-title {
                font-size: 0.9rem;
            }

            .track-title {
                font-size: 0.78rem;
            }

            .track-card {
                padding: 4px 5px;
                gap: 6px;
            }

            .track-thumb {
                width: 36px;
                height: 36px;
            }

            .track-num {
                width: 18px;
            }

            .track-meta {
                font-size: 0.6rem;
            }

            .track-dur {
                font-size: 0.6rem;
            }

            .pl-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                gap: 6px;
            }

            .pl-card {
                border-radius: 8px;
            }

            .pl-card-name {
                font-size: 0.7rem;
            }

            .track-actions {
                opacity: 1;
                gap: 1px;
            }

            .track-actions button {
                width: 24px;
                height: 24px;
                font-size: 0.7rem;
                padding: 2px;
            }

            .modal {
                max-width: 95vw;
                padding: 18px;
            }

            .modal h2 {
                font-size: 0.95rem;
            }

            .modal-input {
                font-size: 0.85rem;
                padding: 8px 10px;
            }

            .modal-btn {
                font-size: 0.8rem;
                padding: 8px;
            }

            #user-badge {
                display: none;
            }
        }

        /* ── Drag to reorder ─────────────────────────────────────────────────────── */
        .track-card.dragging {
            opacity: 0.4;
            transform: scale(0.98);
        }

        .track-card.drag-over {
            border-top: 2px solid var(--accent);
        }

        audio {
            display: none;
        }
    </style>
</head>
<body>
<div class="bg-orbs"></div>
<div id="app">

    <!-- Header -->
    <header>
        <div class="logo">TuneX</div>
        <div class="search-wrap">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
            <input id="q" type="search" placeholder="Search songs, artists…" autocomplete="off" autocorrect="off"
                   spellcheck="false">
        </div>
        <div class="header-right">
            <div id="auth-wrap">
                <input id="apikey" type="password" placeholder="API key">
                <button id="connect-btn" onclick="setKey()">Connect</button>
            </div>
            <div id="user-badge"></div>
            <button id="theme-btn" onclick="toggleThemePanel()" title="Change theme">🎨</button>
        </div>
    </header>

    <!-- Theme panel -->
    <div id="theme-panel">
        <div class="theme-label">Theme</div>
        <div class="theme-options">
            <button class="theme-opt active" data-theme="midnight" onclick="setTheme('midnight')"
                    style="background:#16161f;color:#a78bfa;border-color:#2a2a3a">🌙 Midnight
            </button>
            <button class="theme-opt" data-theme="aurora" onclick="setTheme('aurora')"
                    style="background:#0f1e2c;color:#00d4aa;border-color:#1a3040">🌊 Aurora
            </button>
            <button class="theme-opt" data-theme="ember" onclick="setTheme('ember')"
                    style="background:#201208;color:#ff8040;border-color:#3a2010">🔥 Ember
            </button>
            <button class="theme-opt" data-theme="sakura" onclick="setTheme('sakura')"
                    style="background:#1e1019;color:#f080a8;border-color:#351828">🌸 Sakura
            </button>
            <button class="theme-opt" data-theme="arctic" onclick="setTheme('arctic')"
                    style="background:#f8faff;color:#3060e8;border-color:#d0d8e8">❄️ Arctic
            </button>
            <button class="theme-opt" data-theme="cyberpunk" onclick="setTheme('cyberpunk')"
                    style="background:#240055;color:#ff3385;border-color:#4d0088">🤖 Cyber
            </button>
            <button class="theme-opt" data-theme="forest" onclick="setTheme('forest')"
                    style="background:#0f3318;color:#2dd4bf;border-color:#1a6650">🌲 Forest
            </button>
            <button class="theme-opt" data-theme="sunset" onclick="setTheme('sunset')"
                    style="background:#3d1810;color:#ff8a66;border-color:#8b4423">🌅 Sunset
            </button>
            <button class="theme-opt" data-theme="lavender" onclick="setTheme('lavender')"
                    style="background:#1c1633;color:#c9b8e4;border-color:#5a4d7a">💜 Lavender
            </button>
            <button class="theme-opt" data-theme="obsidian" onclick="setTheme('obsidian')"
                    style="background:#0a0a0a;color:#00ff88;border-color:#303030">⬛ Obsidian
            </button>
        </div>
    </div>

    <!-- Layout -->
    <div class="layout">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="nav-section">
                <div class="nav-label">Discover</div>
                <div class="nav-item active" id="nav-feed" onclick="showPage('feed')">
                    <span class="nav-ico">🏠</span> Feed
                </div>
                <div class="nav-item" id="nav-search" onclick="showPage('search')">
                    <span class="nav-ico">🔍</span> Search
                </div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Library</div>
                <div class="nav-item" id="nav-history" onclick="showPage('history')">
                    <span class="nav-ico">🕐</span> History
                </div>
                <div class="nav-item" id="nav-liked" onclick="showPage('liked')">
                    <span class="nav-ico">❤️</span> Liked
                </div>
                <div class="nav-item" id="nav-playlists" onclick="showPage('playlists')">
                    <span class="nav-ico">📋</span> Playlists
                </div>
            </div>
            <div class="nav-section" style="flex:1">
                <div class="nav-label">My Playlists</div>
                <div class="playlist-items" id="sidebar-playlists"></div>
                <button id="new-pl-btn" onclick="openNewPlaylistModal()">+ New playlist</button>
            </div>
        </aside>

        <!-- Main -->
        <main id="main">
            <div id="main-content" class="page">
                <div class="empty">
                    <div class="empty-icon">🎵</div>
                    <div class="empty-text">Enter your API key to connect</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Player -->
    <div id="player">
        <div id="player-inner">
            <div id="now-playing">
                <img id="now-thumb" src="" alt="">
                <div id="now-info">
                    <div id="now-title" style="color:var(--sub)">Nothing playing</div>
                    <div id="now-channel"></div>
                </div>
                <button id="now-like" onclick="toggleLike()">♡</button>
            </div>
            <div class="player-controls">
                <div class="ctrl-btns">
                    <button class="ctrl-btn" id="shuffle-btn" onclick="toggleShuffle()" title="Shuffle">⇀</button>
                    <button class="ctrl-btn" onclick="skipTrack(-1)" title="Previous">⏮</button>
                    <button class="ctrl-btn" id="play-btn" onclick="togglePlay()">▶</button>
                    <button class="ctrl-btn" onclick="skipTrack(1)" title="Next">⏭</button>
                    <button class="ctrl-btn" id="repeat-btn" onclick="toggleRepeat()" title="Repeat">↺</button>
                </div>
                <div class="progress-row">
                    <span class="time-label" id="t-cur">0:00</span>
                    <div class="progress-wrap" id="progress-wrap" onmousedown="seekStart(event)"
                         ontouchstart="seekStart(event)">
                        <div id="progress-track">
                            <div id="progress-fill"></div>
                        </div>
                    </div>
                    <span class="time-label" id="t-dur">0:00</span>
                </div>
            </div>
            <div class="vol-row">
                <span class="vol-ico" onclick="toggleMute()">🔊</span>
                <div class="vol-track" id="vol-track" onmousedown="volStart(event)">
                    <div class="vol-fill" id="vol-fill" style="width:80%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile nav -->
    <div id="mobile-nav">
        <div class="mobile-nav-inner">
            <div class="mobile-nav-item active" id="mnav-feed" onclick="showPage('feed')">
                <span>🏠</span><span>Home</span></div>
            <div class="mobile-nav-item" id="mnav-search" onclick="showPage('search')"><span>🔍</span><span>Search</span>
            </div>
            <div class="mobile-nav-item" id="mnav-liked" onclick="showPage('liked')"><span>❤️</span><span>Liked</span>
            </div>
            <div class="mobile-nav-item" id="mnav-playlists" onclick="showPage('playlists')">
                <span>📋</span><span>Library</span></div>
        </div>
    </div>

    <!-- New Playlist Modal -->
    <div class="modal-overlay" id="new-pl-modal" onclick="closeModalOnBg(event,'new-pl-modal')">
        <div class="modal">
            <h2>New Playlist</h2>
            <input class="modal-input" id="pl-name-input" placeholder="Playlist name…" maxlength="60">
            <div class="modal-actions">
                <button class="modal-btn secondary" onclick="closeModal('new-pl-modal')">Cancel</button>
                <button class="modal-btn primary" onclick="createPlaylist()">Create</button>
            </div>
        </div>
    </div>

    <!-- Add to playlist modal -->
    <div class="modal-overlay" id="add-to-pl-modal" onclick="closeModalOnBg(event,'add-to-pl-modal')">
        <div class="modal">
            <h2>Add to Playlist</h2>
            <div id="pl-pick-list"
                 style="display:flex;flex-direction:column;gap:6px;max-height:240px;overflow-y:auto;margin-top:4px"></div>
            <div class="modal-actions" style="margin-top:12px">
                <button class="modal-btn secondary" onclick="closeModal('add-to-pl-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Context menu -->
    <div id="ctx-menu">
        <div class="ctx-item" id="ctx-play" onclick="ctxPlay()">▶ Play now</div>
        <div class="ctx-item" id="ctx-next" onclick="ctxPlayNext()">⏭ Play next</div>
        <div class="ctx-item" id="ctx-like" onclick="ctxLike()">♡ Like</div>
        <div class="ctx-item" id="ctx-add-pl" onclick="ctxAddToPlaylist()">📋 Add to playlist</div>
        <div class="ctx-sep" id="ctx-sep-rm" style="display:none"></div>
        <div class="ctx-item danger" id="ctx-remove" style="display:none" onclick="ctxRemove()">✕ Remove</div>
    </div>

    <!-- Toast -->
    <div id="toast"></div>

    <audio id="audio"></audio>

</div>

<script>
    // ── State ───────────────────────────────────────────────────────────────────
    let apiKey = localStorage.getItem('gpi_key') || '';
    let currentPage = 'feed';
    let currentTrack = null;
    let queue = [];
    let queueIndex = -1;
    let likedIds = new Set();
    let playlists = {};          // { id: {name, tracks, ...} }
    let currentPlaylistId = null; // playlist being viewed
    let shuffle = false;
    let repeat = false; // false | 'one' | 'all'
    let isMuted = false;
    let prevVolume = 0.8;
    let ctxTrack = null;
    let ctxRemoveFn = null;
    let seeking = false;
    let volumeDragging = false;
    const audio = document.getElementById('audio');

    // ── Init ────────────────────────────────────────────────────────────────────
    (function init() {
        const theme = localStorage.getItem('gpi_theme') || 'midnight';
        setTheme(theme, false);
        audio.volume = parseFloat(localStorage.getItem('gpi_vol') || '0.8');
        updateVolBar();
        if (apiKey) {
            document.getElementById('apikey').value = apiKey;
            setKey(true);
        }
        document.addEventListener('click', closeCtxMenu);
        document.getElementById('q').addEventListener('keydown', e => {
            if (e.key === 'Enter') doSearch();
        });
        document.getElementById('pl-name-input').addEventListener('keydown', e => {
            if (e.key === 'Enter') createPlaylist();
        });
        setupProgressDrag();
        setupVolDrag();
    })();

    // ── API ─────────────────────────────────────────────────────────────────────
    async function api(path, opts = {}) {
        const r = await fetch(path, {
            ...opts,
            headers: {'X-API-Key': apiKey, 'Content-Type': 'application/json', ...(opts.headers || {})}
        });
        if (!r.ok) throw new Error(`${r.status}: ${await r.text()}`);
        return r.json();
    }

    // ── Auth ────────────────────────────────────────────────────────────────────
    async function setKey(silent = false) {
        apiKey = document.getElementById('apikey').value.trim();
        if (!apiKey) return;
        try {
            const me = await api('/api/me');
            localStorage.setItem('gpi_key', apiKey);
            const badge = document.getElementById('user-badge');
            badge.textContent = '👤 ' + me.username;
            badge.style.display = 'block';
            document.getElementById('auth-wrap').style.display = 'none';
            if (!silent) {
                showPage('feed');
                toast('Connected!');
            } else showPage('feed');
            loadLiked();
            loadPlaylists();
        } catch {
            if (!silent) toast('Invalid API key', true);
        }
    }

    // ── Theme ────────────────────────────────────────────────────────────────────
    function setTheme(name, save = true) {
        document.documentElement.setAttribute('data-theme', name);
        document.querySelector('meta[name=theme-color]').content =
            {
                midnight: '#0a0a0f',
                aurora: '#050d12',
                ember: '#100a06',
                sakura: '#0f080d',
                arctic: '#f2f4f8',
                cyberpunk: '#0a0015',
                forest: '#0a1a0a',
                sunset: '#1a0a05',
                lavender: '#0f0820',
                obsidian: '#060606'
            }[name] || '#0a0a0f';
        document.querySelectorAll('.theme-opt').forEach(el => {
            el.classList.toggle('active', el.dataset.theme === name);
        });
        if (save) localStorage.setItem('gpi_theme', name);
    }

    function toggleThemePanel() {
        const p = document.getElementById('theme-panel');
        p.classList.toggle('open');
    }

    document.addEventListener('click', e => {
        const p = document.getElementById('theme-panel');
        if (!e.target.closest('#theme-panel') && !e.target.closest('#theme-btn')) p.classList.remove('open');
    });

    // ── Pages ────────────────────────────────────────────────────────────────────
    function showPage(name, arg) {
        currentPage = name;
        // Nav highlight
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.mobile-nav-item').forEach(el => el.classList.remove('active'));
        const navEl = document.getElementById('nav-' + name);
        if (navEl) navEl.classList.add('active');
        const mnavEl = document.getElementById('mnav-' + name);
        if (mnavEl) mnavEl.classList.add('active');

        const main = document.getElementById('main-content');
        main.innerHTML = '<div class="loader"><div class="spinner"></div></div>';

        if (name === 'feed') loadFeed();
        else if (name === 'search') renderSearchPage();
        else if (name === 'history') loadHistory();
        else if (name === 'liked') loadLikedPage();
        else if (name === 'playlists') loadPlaylistsPage();
        else if (name === 'playlist') loadPlaylistPage(arg);
    }

    // ── Feed ─────────────────────────────────────────────────────────────────────
    async function loadFeed() {
        try {
            const d = await api('/api/suggestions');
            queue = d.suggestions;
            queueIndex = -1;
            renderTrackList('🎯 For You', d.suggestions, {
                subtitle: d.based_on ? `Based on: ${d.based_on}` : 'Trending'
            });
        } catch (e) {
            setMainError(e);
        }
    }

    // ── Search ───────────────────────────────────────────────────────────────────
    function renderSearchPage() {
        document.getElementById('main-content').innerHTML = `
    <div class="page">
      <div class="section-header"><div><div class="section-title">🔍 Search</div></div></div>
      <div id="search-results"><div class="empty"><div class="empty-icon">🎵</div><div class="empty-text">Search for something above</div></div></div>
    </div>`;
    }

    async function doSearch() {
        const q = document.getElementById('q').value.trim();
        if (!q || !apiKey) return;
        if (currentPage !== 'search') showPage('search');
        const el = document.getElementById('search-results') || document.getElementById('main-content');
        el.innerHTML = '<div class="loader"><div class="spinner"></div></div>';
        try {
            const d = await api('/api/search?q=' + encodeURIComponent(q));
            queue = d.results;
            queueIndex = -1;
            renderTrackList('', d.results, {container: 'search-results', noPage: true});
        } catch (e) {
            el.innerHTML = `<div class="empty"><div class="empty-text">❌ ${escHtml(e.message)}</div></div>`;
        }
    }

    // ── History ───────────────────────────────────────────────────────────────────
    async function loadHistory() {
        try {
            const d = await api('/api/history');
            queue = d.history;
            queueIndex = -1;
            renderTrackList('🕐 Recently Played', d.history);
        } catch (e) {
            setMainError(e);
        }
    }

    // ── Liked ─────────────────────────────────────────────────────────────────────
    async function loadLiked() {
        try {
            const d = await api('/api/liked');
            likedIds = new Set(d.liked);
            document.querySelectorAll('.like-btn').forEach(b => {
                b.textContent = likedIds.has(b.dataset.id) ? '❤️' : '♡';
                b.classList.toggle('liked', likedIds.has(b.dataset.id));
            });
            updateNowLike();
        } catch {
        }
    }

    async function loadLikedPage() {
        try {
            const d = await api('/api/liked');
            likedIds = new Set(d.liked);
            if (!d.liked.length) {
                renderTrackList('❤️ Liked', []);
                return;
            }
            const tracks = (await Promise.all(d.liked.slice(0, 30).map(id => api('/api/track/' + id).catch(() => null)))).filter(Boolean);
            queue = tracks;
            queueIndex = -1;
            renderTrackList('❤️ Liked Songs', tracks);
        } catch (e) {
            setMainError(e);
        }
    }

    // ── Playlists ─────────────────────────────────────────────────────────────────
    async function loadPlaylists() {
        try {
            const d = await api('/api/playlists');
            playlists = {};
            d.playlists.forEach(p => playlists[p.id] = p);
            renderSidebarPlaylists();
        } catch {
        }
    }

    function renderSidebarPlaylists() {
        const el = document.getElementById('sidebar-playlists');
        el.innerHTML = Object.values(playlists).slice(0, 8).map(p => `
    <div class="pl-nav-item ${currentPlaylistId === p.id ? 'active' : ''}" onclick="showPage('playlist','${p.id}')">
      <span class="pl-dot"></span>${escHtml(p.name)}
    </div>`).join('');
    }

    async function loadPlaylistsPage() {
        try {
            const d = await api('/api/playlists');
            playlists = {};
            d.playlists.forEach(p => playlists[p.id] = p);
            renderSidebarPlaylists();
            const main = document.getElementById('main-content');
            main.innerHTML = `
      <div class="page">
        <div class="section-header">
          <div><div class="section-title">📋 Playlists</div></div>
          <button class="section-action" onclick="openNewPlaylistModal()">+ New</button>
        </div>
        <div class="pl-grid">
          <div class="new-pl-card" onclick="openNewPlaylistModal()">
            <span style="font-size:1.5rem">＋</span>
            <span>New Playlist</span>
          </div>
          ${d.playlists.map(p => `
            <div class="pl-card" onclick="showPage('playlist','${p.id}')">
              <div class="pl-thumb">${p.thumbnail ? `<img src="${escHtml(p.thumbnail)}" alt="">` : '🎵'}</div>
              <div class="pl-card-info">
                <div class="pl-card-name">${escHtml(p.name)}</div>
                <div class="pl-card-count">${p.count} tracks</div>
              </div>
            </div>`).join('')}
        </div>
      </div>`;
        } catch (e) {
            setMainError(e);
        }
    }

    async function loadPlaylistPage(pid) {
        currentPlaylistId = pid;
        renderSidebarPlaylists();
        try {
            const pl = await api('/api/playlists/' + pid);
            playlists[pid] = pl;
            queue = pl.tracks || [];
            queueIndex = -1;
            const main = document.getElementById('main-content');
            main.innerHTML = `
      <div class="page">
        <div class="section-header">
          <div>
            <div class="section-title">📋 ${escHtml(pl.name)}</div>
            <div class="section-sub">${pl.tracks.length} tracks</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="section-action" onclick="playPlaylist('${pid}')">▶ Play all</button>
            <button class="section-action" onclick="renamePlaylist('${pid}')">✏️</button>
            <button class="section-action" style="color:#f06060" onclick="deletePlaylist('${pid}')">🗑</button>
          </div>
        </div>
        <div class="track-list" id="pl-track-list"></div>
      </div>`;
            renderPlaylistTracks(pid, pl.tracks);
        } catch (e) {
            setMainError(e);
        }
    }

    function renderPlaylistTracks(pid, tracks) {
        const list = document.getElementById('pl-track-list');
        if (!list) return;
        if (!tracks.length) {
            list.innerHTML = '<div class="empty"><div class="empty-icon">🎵</div><div class="empty-text">Playlist is empty</div></div>';
            return;
        }
        list.innerHTML = tracks.map((t, i) => buildTrackCard(t, i, {removable: true, pid})).join('');
        setupDragReorder(pid);
    }

    async function playPlaylist(pid) {
        const pl = playlists[pid];
        if (!pl || !pl.tracks?.length) return;
        queue = pl.tracks;
        queueIndex = 0;
        await playTrack(queue[0], 0);
    }

    async function deletePlaylist(pid) {
        if (!confirm('Delete this playlist?')) return;
        await api('/api/playlists/' + pid, {method: 'DELETE'});
        delete playlists[pid];
        toast('Playlist deleted');
        showPage('playlists');
        renderSidebarPlaylists();
    }

    async function renamePlaylist(pid) {
        const name = prompt('Rename playlist:', playlists[pid]?.name || '');
        if (!name?.trim()) return;
        await api('/api/playlists/' + pid, {method: 'PATCH', body: JSON.stringify({name: name.trim()})});
        if (playlists[pid]) playlists[pid].name = name.trim();
        toast('Renamed!');
        showPage('playlist', pid);
        renderSidebarPlaylists();
    }

    // Drag-to-reorder for playlists
    function setupDragReorder(pid) {
        const list = document.getElementById('pl-track-list');
        if (!list) return;
        let dragged = null;
        list.querySelectorAll('.track-card').forEach(card => {
            card.setAttribute('draggable', 'true');
            card.addEventListener('dragstart', e => {
                dragged = card;
                card.classList.add('dragging');
            });
            card.addEventListener('dragend', () => {
                dragged?.classList.remove('dragging');
                dragged = null;
                list.querySelectorAll('.track-card').forEach(c => c.classList.remove('drag-over'));
            });
            card.addEventListener('dragover', e => {
                e.preventDefault();
                if (dragged && card !== dragged) card.classList.add('drag-over');
            });
            card.addEventListener('dragleave', () => card.classList.remove('drag-over'));
            card.addEventListener('drop', async e => {
                e.preventDefault();
                card.classList.remove('drag-over');
                if (!dragged || dragged === card) return;
                const cards = [...list.querySelectorAll('.track-card')];
                const fromIdx = cards.indexOf(dragged), toIdx = cards.indexOf(card);
                if (fromIdx < 0 || toIdx < 0) return;
                card.parentNode.insertBefore(dragged, fromIdx < toIdx ? card.nextSibling : card);
                const newOrder = [...list.querySelectorAll('.track-card')].map(c => c.dataset.id);
                await api('/api/playlists/' + pid + '/tracks', {method: 'PUT', body: JSON.stringify(newOrder)});
                if (playlists[pid]) {
                    const map = Object.fromEntries((playlists[pid].tracks || []).map(t => [t.id, t]));
                    playlists[pid].tracks = newOrder.map(id => map[id]).filter(Boolean);
                }
            });
        });
    }

    // New playlist
    function openNewPlaylistModal() {
        document.getElementById('pl-name-input').value = '';
        document.getElementById('new-pl-modal').classList.add('open');
        setTimeout(() => document.getElementById('pl-name-input').focus(), 100);
    }

    async function createPlaylist() {
        const name = document.getElementById('pl-name-input').value.trim();
        if (!name) return;
        const pl = await api('/api/playlists', {method: 'POST', body: JSON.stringify({name})});
        playlists[pl.id] = {...pl, tracks: []};
        closeModal('new-pl-modal');
        toast('Playlist created!');
        renderSidebarPlaylists();
        showPage('playlist', pl.id);
    }

    // Add to playlist modal
    function openAddToPlaylist(track) {
        ctxTrack = track;
        const list = document.getElementById('pl-pick-list');
        const pls = Object.values(playlists);
        if (!pls.length) {
            list.innerHTML = '<div style="color:var(--sub);font-size:.85rem;padding:8px">No playlists yet. Create one first!</div>';
        } else {
            list.innerHTML = pls.map(p => `
      <div class="ctx-item" onclick="addTrackToPlaylist('${p.id}')">
        <span>📋</span> ${escHtml(p.name)} <span style="color:var(--sub);font-size:.75rem;margin-left:auto">${(p.count || p.tracks?.length || 0)} tracks</span>
      </div>`).join('');
        }
        document.getElementById('add-to-pl-modal').classList.add('open');
    }

    async function addTrackToPlaylist(pid) {
        if (!ctxTrack) return;
        await api('/api/playlists/' + pid + '/tracks', {method: 'POST', body: JSON.stringify(ctxTrack)});
        if (playlists[pid]) {
            playlists[pid].count = (playlists[pid].count || 0) + 1;
            if (playlists[pid].tracks) playlists[pid].tracks.push(ctxTrack);
        }
        closeModal('add-to-pl-modal');
        toast('Added to playlist!');
    }

    // ── Render helpers ────────────────────────────────────────────────────────────
    function buildTrackCard(t, i, opts = {}) {
        const {removable, pid} = opts;
        const dur = t.duration ? fmtTime(t.duration) : '--:--';
        const isLiked = likedIds.has(t.id);
        const isActive = currentTrack?.id === t.id;
        return `
    <div class="track-card ${isActive ? 'active' : ''}" data-id="${t.id}"
      onclick="handleTrackClick(event,'${t.id}',${i})"
      oncontextmenu="showCtxMenu(event,'${t.id}',${removable ? `'${pid}'` : 'null'})">
      <div class="track-num">${i + 1}</div>
      <div class="playing-icon"><div class="playing-bars"><span></span><span></span><span></span></div></div>
      <img class="track-thumb" src="${escHtml(t.thumbnail || '')}" alt="" loading="lazy" onerror="this.style.opacity=.2">
      <div class="track-info">
        <div class="track-title">${escHtml(t.title || '')}</div>
        <div class="track-meta">${escHtml(t.channel || '')}</div>
      </div>
      <div class="track-dur">${dur}</div>
      <div class="track-actions">
        <button class="like-btn ${isLiked ? 'liked' : ''}" data-id="${t.id}" onclick="event.stopPropagation();quickLike('${t.id}',this)" title="Like">${isLiked ? '❤️' : '♡'}</button>
        ${removable ? `<button onclick="event.stopPropagation();removeFromPlaylist('${pid}','${t.id}')" title="Remove" style="color:var(--sub)">✕</button>` : ''}
      </div>
    </div>`;
    }

    function renderTrackList(title, tracks, opts = {}) {
        const {subtitle, container, noPage} = opts;
        const target = container ? document.getElementById(container) : null;
        const main = target || document.getElementById('main-content');
        if (!tracks?.length) {
            main.innerHTML = `${noPage ? '' : '<div class="page">'}
      ${title ? `<div class="section-header"><div><div class="section-title">${title}</div>${subtitle ? `<div class="section-sub">${subtitle}</div>` : ''}</div></div>` : ''}
      <div class="empty"><div class="empty-icon">🎵</div><div class="empty-text">Nothing here yet</div></div>
    ${noPage ? '' : '</div>'}`;
            return;
        }
        main.innerHTML = `${noPage ? '' : '<div class="page">'}
    ${title ? `<div class="section-header"><div><div class="section-title">${title}</div>${subtitle ? `<div class="section-sub">${subtitle}</div>` : ''}</div></div>` : ''}
    <div class="track-list">${tracks.map((t, i) => buildTrackCard(t, i)).join('')}</div>
  ${noPage ? '' : '</div>'}`;
    }

    function handleTrackClick(e, id, idx) {
        if (e.target.closest('.track-actions')) return;
        const t = queue.find(t => t.id === id) || queue[idx];
        if (t) playTrack(t, idx);
    }

    function setMainError(e) {
        document.getElementById('main-content').innerHTML =
            `<div class="empty"><div class="empty-icon">⚠️</div><div class="empty-text">${escHtml(e.message)}</div></div>`;
    }

    // ── Playback ──────────────────────────────────────────────────────────────────
    async function playTrack(track, idx, newQueue) {
        if (newQueue) {
            queue = newQueue;
        }
        if (idx !== undefined) queueIndex = idx;
        currentTrack = track;

        // Update UI immediately
        document.getElementById('now-title').textContent = '⏳ Loading…';
        document.getElementById('now-channel').textContent = track.channel || '';
        document.getElementById('now-thumb').src = track.thumbnail || '';
        document.getElementById('now-thumb').classList.add('spinning');
        document.getElementById('play-btn').textContent = '⏸';
        document.getElementById('play-btn').classList.add('loading');
        updateNowLike();
        highlightActive(track.id);

        // Prefetch next tracks
        const nextIds = getNextIds(3).join(',');

        try {
            const d = await api(`/api/stream/${track.id}${nextIds ? '?next_ids=' + nextIds : ''}`);
            audio.src = d.stream_url;
            audio.volume = isMuted ? 0 : parseFloat(localStorage.getItem('gpi_vol') || '0.8');
            await audio.play();
            document.getElementById('now-title').textContent = d.track.title || track.title;
            document.getElementById('now-thumb').classList.remove('spinning');
            document.getElementById('play-btn').classList.remove('loading');
            document.title = `${d.track.title} — TuneX`;
        } catch (e) {
            document.getElementById('now-title').textContent = '❌ ' + (track.title || 'Failed');
            document.getElementById('play-btn').textContent = '▶';
            document.getElementById('play-btn').classList.remove('loading');
            document.getElementById('now-thumb').classList.remove('spinning');
            toast('Failed to load track', true);
        }
    }

    function getNextIds(n) {
        if (!queue.length) return [];
        const ids = [];
        for (let i = 1; i <= n; i++) {
            const idx = (queueIndex + i) % queue.length;
            if (queue[idx]) ids.push(queue[idx].id);
        }
        return [...new Set(ids)];
    }

    function highlightActive(id) {
        document.querySelectorAll('.track-card').forEach(c => {
            c.classList.toggle('active', c.dataset.id === id);
        });
    }

    function togglePlay() {
        if (!audio.src) return;
        if (audio.paused) {
            audio.play();
            document.getElementById('play-btn').textContent = '⏸';
        } else {
            audio.pause();
            document.getElementById('play-btn').textContent = '▶';
        }
    }

    function skipTrack(dir) {
        if (!queue.length) return;
        if (repeat === 'one') {
            audio.currentTime = 0;
            audio.play();
            return;
        }
        let next;
        if (shuffle) {
            next = Math.floor(Math.random() * queue.length);
        } else {
            next = queueIndex + dir;
            if (repeat === 'all') next = ((next % queue.length) + queue.length) % queue.length;
            else next = Math.max(0, Math.min(queue.length - 1, next));
        }
        queueIndex = next;
        playTrack(queue[next], next);
    }

    function toggleShuffle() {
        shuffle = !shuffle;
        document.getElementById('shuffle-btn').classList.toggle('active', shuffle);
        toast(shuffle ? 'Shuffle on' : 'Shuffle off');
    }

    function toggleRepeat() {
        const states = [false, 'all', 'one'];
        const icons = ['↺', '↺', '↩'];
        repeat = states[(states.indexOf(repeat) + 1) % states.length];
        const btn = document.getElementById('repeat-btn');
        btn.textContent = icons[states.indexOf(repeat)];
        btn.classList.toggle('active', repeat !== false);
        toast(repeat === false ? 'Repeat off' : repeat === 'all' ? 'Repeat all' : 'Repeat one');
    }

    // Audio events
    audio.addEventListener('ended', () => {
        if (repeat === 'one') {
            audio.currentTime = 0;
            audio.play();
            return;
        }
        const hasNext = shuffle || queueIndex < queue.length - 1 || repeat === 'all';
        if (hasNext) skipTrack(1);
        else {
            document.getElementById('play-btn').textContent = '▶';
            document.title = 'TuneX';
        }
    });
    audio.addEventListener('pause', () => {
        if (!seeking) document.getElementById('play-btn').textContent = '▶';
    });
    audio.addEventListener('play', () => document.getElementById('play-btn').textContent = '⏸');
    audio.addEventListener('timeupdate', updateProgress);

    // ── Progress ──────────────────────────────────────────────────────────────────
    function updateProgress() {
        if (!audio.duration || seeking) return;
        const pct = (audio.currentTime / audio.duration) * 100;
        document.getElementById('progress-fill').style.width = pct + '%';
        document.getElementById('t-cur').textContent = fmtTime(audio.currentTime);
        document.getElementById('t-dur').textContent = fmtTime(audio.duration);
    }

    function setupProgressDrag() {
        const wrap = document.getElementById('progress-wrap');

        function doSeek(e) {
            const rect = wrap.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const pct = Math.max(0, Math.min(1, x / rect.width));
            if (audio.duration) audio.currentTime = audio.duration * pct;
            document.getElementById('progress-fill').style.width = (pct * 100) + '%';
        }

        wrap.addEventListener('mousedown', e => {
            seeking = true;
            doSeek(e);
        });
        wrap.addEventListener('touchstart', e => {
            seeking = true;
            doSeek(e);
        }, {passive: true});
        document.addEventListener('mousemove', e => {
            if (seeking) doSeek(e);
        });
        document.addEventListener('touchmove', e => {
            if (seeking) doSeek(e);
        }, {passive: true});
        document.addEventListener('mouseup', () => {
            seeking = false;
        });
        document.addEventListener('touchend', () => {
            seeking = false;
        });
    }

    // ── Volume ────────────────────────────────────────────────────────────────────
    function setupVolDrag() {
        const track = document.getElementById('vol-track');

        function doVol(e) {
            const rect = track.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const pct = Math.max(0, Math.min(1, x / rect.width));
            audio.volume = pct;
            prevVolume = pct;
            localStorage.setItem('gpi_vol', pct);
            updateVolBar();
        }

        track.addEventListener('mousedown', e => {
            volumeDragging = true;
            doVol(e);
        });
        track.addEventListener('touchstart', e => {
            volumeDragging = true;
            doVol(e);
        }, {passive: true});
        document.addEventListener('mousemove', e => {
            if (volumeDragging) doVol(e);
        });
        document.addEventListener('touchmove', e => {
            if (volumeDragging) doVol(e);
        }, {passive: true});
        document.addEventListener('mouseup', () => volumeDragging = false);
        document.addEventListener('touchend', () => volumeDragging = false);
    }

    function updateVolBar() {
        document.getElementById('vol-fill').style.width = (audio.volume * 100) + '%';
    }

    function toggleMute() {
        isMuted = !isMuted;
        audio.volume = isMuted ? 0 : prevVolume;
        document.querySelector('.vol-ico').textContent = isMuted ? '🔇' : '🔊';
        if (!isMuted) updateVolBar();
    }

    // ── Likes ─────────────────────────────────────────────────────────────────────
    async function quickLike(id, btn) {
        const liked = likedIds.has(id);
        try {
            if (liked) {
                await api('/api/like/' + id, {method: 'DELETE'});
                likedIds.delete(id);
                btn.textContent = '♡';
                btn.classList.remove('liked');
            } else {
                await api('/api/like/' + id, {method: 'POST'});
                likedIds.add(id);
                btn.textContent = '❤️';
                btn.classList.add('liked');
            }
            updateNowLike();
        } catch {
        }
    }

    async function toggleLike() {
        if (!currentTrack) return;
        const btn = document.getElementById('now-like');
        const fakeBtn = {
            textContent: '', classList: {
                add() {
                }, remove() {
                }, toggle() {
                }
            }
        };
        const lb = document.querySelector(`.like-btn[data-id="${currentTrack.id}"]`) || fakeBtn;
        await quickLike(currentTrack.id, lb);
        updateNowLike();
    }

    function updateNowLike() {
        const btn = document.getElementById('now-like');
        const liked = currentTrack && likedIds.has(currentTrack.id);
        btn.textContent = liked ? '❤️' : '♡';
        btn.classList.toggle('liked', !!liked);
    }

    // ── Context menu ──────────────────────────────────────────────────────────────
    let ctxVideoId = null, ctxPid = null;

    function showCtxMenu(e, id, pid) {
        e.preventDefault();
        e.stopPropagation();
        ctxVideoId = id;
        ctxPid = pid !== 'null' ? pid : null;
        ctxTrack = queue.find(t => t.id === id);
        const menu = document.getElementById('ctx-menu');
        document.getElementById('ctx-sep-rm').style.display = ctxPid ? '' : 'none';
        document.getElementById('ctx-remove').style.display = ctxPid ? '' : 'none';
        menu.classList.add('open');
        const x = Math.min(e.clientX, window.innerWidth - 200);
        const y = Math.min(e.clientY, window.innerHeight - 200);
        menu.style.left = x + 'px';
        menu.style.top = y + 'px';
        // Update like label
        document.getElementById('ctx-like').textContent = (likedIds.has(id) ? '💔' : '♡') + ' ' + (likedIds.has(id) ? 'Unlike' : 'Like');
    }

    function closeCtxMenu(e) {
        if (!e.target.closest('#ctx-menu')) document.getElementById('ctx-menu').classList.remove('open');
    }

    function ctxPlay() {
        const idx = queue.findIndex(t => t.id === ctxVideoId);
        if (idx >= 0) playTrack(queue[idx], idx);
        document.getElementById('ctx-menu').classList.remove('open');
    }

    function ctxPlayNext() {
        const t = queue.find(t => t.id === ctxVideoId);
        if (!t) return;
        queue.splice(queueIndex + 1, 0, t);
        toast('Playing next');
        document.getElementById('ctx-menu').classList.remove('open');
    }

    function ctxLike() {
        const lb = document.querySelector(`.like-btn[data-id="${ctxVideoId}"]`) || {
            textContent: '', classList: {
                add() {
                }, remove() {
                }, toggle() {
                }
            }
        };
        quickLike(ctxVideoId, lb);
        document.getElementById('ctx-menu').classList.remove('open');
    }

    function ctxAddToPlaylist() {
        document.getElementById('ctx-menu').classList.remove('open');
        openAddToPlaylist(ctxTrack);
    }

    async function ctxRemove() {
        if (!ctxPid || !ctxVideoId) return;
        await removeFromPlaylist(ctxPid, ctxVideoId);
        document.getElementById('ctx-menu').classList.remove('open');
    }

    async function removeFromPlaylist(pid, vid) {
        await api(`/api/playlists/${pid}/tracks/${vid}`, {method: 'DELETE'});
        if (playlists[pid]?.tracks) playlists[pid].tracks = playlists[pid].tracks.filter(t => t.id !== vid);
        const card = document.querySelector(`.track-card[data-id="${vid}"]`);
        if (card) {
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            card.style.transition = 'all 0.25s';
            setTimeout(() => card.remove(), 250);
        }
        toast('Removed from playlist');
    }

    // ── Modals ────────────────────────────────────────────────────────────────────
    function closeModal(id) {
        document.getElementById(id).classList.remove('open');
    }

    function closeModalOnBg(e, id) {
        if (e.target === document.getElementById(id)) closeModal(id);
    }

    // ── Toast ─────────────────────────────────────────────────────────────────────
    let toastTimer;

    function toast(msg, err = false) {
        const el = document.getElementById('toast');
        el.textContent = msg;
        el.style.background = err ? '#3a1010' : 'var(--card)';
        el.style.color = err ? '#f08080' : 'var(--text)';
        el.classList.add('show');
        clearTimeout(toastTimer);
        toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
    }

    // ── Seek bar click ─────────────────────────────────────────────────────────────
    function seekStart(e) {
        // handled by setupProgressDrag
    }

    // ── Vol bar click ──────────────────────────────────────────────────────────────
    function volStart(e) {
        // handled by setupVolDrag
    }

    // ── Utils ─────────────────────────────────────────────────────────────────────
    function fmtTime(s) {
        s = Math.floor(s);
        const m = Math.floor(s / 60);
        return m + ':' + String(s % 60).padStart(2, '0');
    }

    function escHtml(s) {
        return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
</script>
</body>
</html>
